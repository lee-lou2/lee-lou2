---
title: 'ElasticSearch ê¸°ë³¸ Query'
authors: [jake]
tags: [nosql, es, elasticsearch]
---

## â­ í‚¤ì›Œë“œ

| í‚¤ì›Œë“œ | ì„¤ëª… |
| --- | --- |
| Elastic Search | Search ì—”ì§„ì— ìµœì í™”ëœ NoSql |

## ğŸ¥ ì˜ˆì‹œ

```python
# ElasticSearch Search Query Example
{
  # ëª‡ê°œì˜ ë°ì´í„°ë¥¼ í‘œì‹œí•˜ëŠ”ê°€?ìµœëŒ€ 10,000ê°œê¹Œì§€ í‘œì‹œ
  "size": 30,
  # ë°ì´í„° ì •ë ¬ ë°©ì‹
  "sort": [{"update_date": "desc"}],
  # ì¡°ê±´ë¬¸
  "query": {
    "bool": {
      # í•„í„°
      "filter": [
        # ì•„ë˜ 3ê°œì˜ í•„ë“œì˜ ê°’ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¡°íšŒ
        {"exists": {"field": "member_seq"}},
        {"exists": {"field": "content_type"}},
        {"exists": {"field": "content_seq"}},
      ],
      "must": [
        # ê¸°ê°„ ë²”ìœ„ ì„¤ì •(+9h ëŠ” utc ê³ ë ¤)
        {"range": {"update_date": {"gte": "now-1d+9h", "lt": "2022-12-09 15:16:12"}}},
        # ì„œë¹„ìŠ¤ì¤‘ì¸ ë„ì„œë§Œ
        {"term": {"is_service": "true"}},
        # ëŒ€ì—¬ê°€ëŠ¥í•œ ë„ì„œë§Œ
        {"term": {"is_rent": "true"}},
        # í•´ë‹¹ ì‹œí€€ìŠ¤ì˜ ì‚¬ìš©ì í”¼ë“œë§Œ
        {"terms": {"mem_seq": [1234]}},
      ],
      "must_not": [
        # í•´ë‹¹ ì‹œí€€ìŠ¤ ì‚¬ìš©ìëŠ” ì¡°íšŒí•˜ì§€ ì•ŠìŒ
        {"terms": {"mem_seq": [2345]}},
        # ì‚­ì œì²˜ë¦¬ëœ í”¼ë“œëŠ” ì¡°íšŒí•˜ì§€ ì•ŠìŒ
        {"term": {"is_delete": "true"}},
        # ì•„ë˜ id ë¥¼ ê°–ê³  ìˆëŠ” í”¼ë“œëŠ” ì¡°íšŒí•˜ì§€ ì•ŠìŒ(ì™„ì „íˆ ì¼ì¹˜)
        {"terms": {"_id": ["123-456-POST"]}},
        # ì•„ë˜ í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ í”¼ë“œëŠ” ì¡°íšŒí•˜ì§€ ì•ŠìŒ
        {"script": {"script": "doc['_id'][0].indexOf('123-REVIEW') > -1"}},
        # ì•„ë˜ ì»¨í…ì¸  íƒ€ì…ì€ ì¡°íšŒí•˜ì§€ ì•ŠìŒ
        {"term": {"content_type": "POST"}}
      ]
    }
  }
}

# ElasticSearch GroupBy Query Example
{
  # ì „ì²´ ë°ì´í„° ê¸°ì¤€
  "size": 0,
  # ê¸°ì¡´ê³¼ ë™ì¼
  "query": {
    "bool": {
      "must": [
        {"range": {...}}
        ...
      ]
    }
  },
  "aggs": {
    # ìœ„ ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ë¥¼ ì•„ë˜ ë¶ì‹œí€€ìŠ¤ë¡œ ê·¸ë£¹í•‘
    {"group_by_state": {"terms": {"field": "book_seq"}}}
  }
}

# ElasticSearch Append Query Example
{
  "script": {
    "lang": "painless", 
    "source": (
      "if(!ctx._source['field'].contains(params['field'])) {
        ctx._source['field'].add(params['field'])
      }"
    ),
    "params": {"field": "value"}
  }
}
```