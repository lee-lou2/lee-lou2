---
title: 'íŠ¹ì • API ë§Œ slave ë¼ìš°í„°ë¥¼ ë°”ë¼ë³´ë„ë¡ ì ìš©'
authors: [ jake ]
tags: [ django, db, router, decorator ]
---

## ğŸ¥ ì˜ˆì‹œ

```python
import threading

from django.conf import settings

from base.utils import get_settings_module


# API ë³„ ë°ì´í„°ë² ì´ìŠ¤ ë¼ìš°íŒ…ì„ ìœ„í•´ Threading Local í™œìš©
# ==> í•´ë‹¹ ê°’ì€ API ë³„ë¡œ ì´ˆê¸°í™”ë˜ì–´ [ì „ì—­]ì—ì„œ í™œìš© ê°€ëŠ¥
thread_local = threading.local()


def use_db_for_reads_decorator(func):
    """ìŠ¬ë ˆì´ë¸Œ ë°ì´í„°ë² ì´ìŠ¤ ë¼ìš°í„° - ë°ì½”ë ˆì´í„°"""

    def func_wrapper(*args, **kwargs):
        """íŠ¹ì • ë²”ìœ„ ìŠ¬ë ˆì´ë¸Œ ì ìš©"""
        setattr(thread_local, "DB_FOR_READ_ONLY", "slave")
        _func = func(*args, **kwargs)
        setattr(thread_local, "DB_FOR_READ_ONLY", None)
        return _func

    return func_wrapper


class DefaultRouter:
    """ë°ì´í„°ë² ì´ìŠ¤ ë¼ìš°í„°"""

    route_app_labels = list(set(settings.DATABASES.keys()))

    def db_for_read(self, model, **hints):
        """ì½ê¸°ì—ì„œ ì‚¬ìš©í•  ë°ì´í„°ë² ì´ìŠ¤"""

        # 1. ê¸°ë³¸ ë¼ìš°íŒ…
        if model._meta.app_label in self.route_app_labels:
            return model._meta.app_label

        # 2. í…ŒìŠ¤íŠ¸ í™˜ê²½ ì™¸ì—” ì½ê¸°ë¥¼ Slave ë¡œ ì„¤ì •
        if "test" in get_settings_module():
            return "default"

        # 3. íŠ¹ì • APIë§Œ slave ì ìš©, ê·¸ ì™¸ None ì²˜ë¦¬
        return getattr(thread_local, "DB_FOR_READ_ONLY", None)

    def db_for_write(self, model, **hints):
        """ì“°ê¸°ì—ì„œ ì‚¬ìš©í•  ë°ì´í„°ë² ì´ìŠ¤"""

        # 1. Slave Host ì™€ ë™ì¼í•œ ë¼ìš°í„°ì˜ ê²½ìš° "default"ë¡œ ê°•ì œ
        db_list = [
            key for key, value in settings.DATABASES.items()
            if value.get("HOST") == settings.DATABASES.get("slave").get("HOST")
        ]
        if model._meta.app_label in db_list:
            return "default"

        # 2. ê¸°ë³¸ ë¼ìš°íŒ…
        if model._meta.app_label in self.route_app_labels:
            return model._meta.app_label

        # 3. ê·¸ ì™¸, ë‹¤ìŒ ë¼ìš°í„° ë˜ëŠ” default ë¡œ ì ìš©
        return None

    def allow_relation(self, obj1, obj2, **hints):
        """ì—°ê²° í—ˆìš© ì—¬ë¶€ í™•ì¸"""

        # 1. ë™ì¼í•œ ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ëŠ” ì—°ê²° í—ˆìš©
        default_host = settings.DATABASES.get("default").get("HOST")
        slave_host = settings.DATABASES.get("slave").get("HOST")
        db_list = [
            key for key, value in settings.DATABASES.items()
            if value.get("HOST") in [default_host, slave_host]
        ]
        if obj1._state.db in db_list and obj2._state.db in db_list:
            return True

        # 2. Host ê°€ ë™ì¼í•œ ê²½ìš° ì—°ê²° í—ˆìš©
        obj1_host = settings.DATABASES.get(str(obj1._state.db), {}).get("HOST")
        obj2_host = settings.DATABASES.get(str(obj2._state.db), {}).get("HOST")
        if obj1_host is not None and obj1_host == obj2_host:
            return True

        # 3. ê·¸ ì™¸, ë‹¤ìŒ ë¼ìš°í„° ë˜ëŠ” default ë¡œ ì ìš©
        return None
```
