---
title: ëª¨ë¸ í™œìš©
sidebar_label: 3. Django ëª¨ë¸ í™œìš©
description: Django ëª¨ë¸ ì„¤ëª…
sidebar_position: 3
---

# Models / ORM

## ëª¨ë¸ ê¸°ë³¸ í•„ë“œ.
---

| Field Type                                        | Description                           |
|:--------------------------------------------------|:--------------------------------------|
| `models.AutoField`                                | ìë™ ì¦ê°€ ê°’ í•„ë“œ                            |
| `models.IntegerField` (`Positive...IntegerField`) | ìˆ«ì í•„ë“œ                                 |
| `models.DateTimeField` (`models.DateField`)       | Datetime : ë…„/ì›”/ì¼/ì‹œ <br/> Date : ë…„/ì›”/ì¼ |
| `models.CharField`                                | ë¬¸ìì—´ í•„ë“œ(varchar)                       |
| `models.TextField`                                | í…ìŠ¤íŠ¸ í•„ë“œ                                |
| `models.ForeignKey`                               | ì¼ëŒ€ë‹¤ ê´€ê³„                                |
| `models.OneToOneField`                            | ì¼ëŒ€ì¼ ê´€ê³„                                |
| `models.ManyToManyField`                          | ë‹¤ëŒ€ë‹¤ ê´€ê³„                                |

## ì†ì„±

---

| Field Name                | Description                                                                                                                                                                                                                                                                                                                                                                                                                 |
|:--------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `help_text`               | ì»¬ëŸ¼ ì„¤ëª…                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `db_column`               | ë°ì´í„°ë² ì´ìŠ¤ ì»¬ëŸ¼ëª… <br/> ê¸°ë³¸ ê°’: ëª¨ë¸ë§ì— ì‚¬ìš©ëœ ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ìƒì„±, ë‹¨, Foreignkey ë“±ì€ ì‘ì„±ëœ ì»¬ëŸ¼ëª… + â€œ_idâ€ ê°€ ë¶™ëŠ”ë‹¤                                                                                                                                                                                                                                                                                                                                         |
| `null` `blank`            | -                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `primary_key`             | -                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `to`                      | ëŒ€ìƒ ì°¸ì¡° í…Œì´ë¸”(í…Œì´ë¸” í´ë˜ìŠ¤ ë˜ëŠ” í´ë˜ìŠ¤ëª… ë¬¸ìì—´ë¡œ ì‘ì„±)                                                                                                                                                                                                                                                                                                                                                                                          |
| `related_name`            | ê¸°ë³¸ ê°’(ì†Œë¬¸ì í…Œì´ë¸”ëª… + â€œ_setâ€)                                                                                                                                                                                                                                                                                                                                                                                                     |
| `on_delete`               | **CASCADE** : ForeignKeyFieldë¥¼ í¬í•¨í•˜ëŠ” ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤(row)ë„ ê°™ì´ ì‚­ì œí•œë‹¤ <br/> **PROTECT** : í•´ë‹¹ ìš”ì†Œê°€ ê°™ì´ ì‚­ì œë˜ì§€ ì•Šë„ë¡ ProtectedErrorë¥¼ ë°œìƒì‹œí‚¨ë‹¤ <br/> **SET_NULL** : ForeignKeyField ê°’ì„ NULLë¡œ ë°”ê¾¼ë‹¤. null=Trueì¼ ë•Œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ <br/> **SET_DEFAULT** : ForeignKeyField ê°’ì„ default ê°’ìœ¼ë¡œ ë³€ê²½í•œë‹¤. default ê°’ì´ ìˆì„ ë•Œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. <br/> **SET()** : ForeignKeyField ê°’ì„ SETì— ì„¤ì •ëœ í•¨ìˆ˜ ë“±ì— ì˜í•´ ì„¤ì •í•œë‹¤ <br/> **DO_NOTHING** : ì•„ë¬´ëŸ° í–‰ë™ì„ ì·¨í•˜ì§€ ì•ŠëŠ”ë‹¤. ì°¸ì¡° ë¬´ê²°ì„±ì„ í•´ì¹  ìœ„í—˜ì´ ìˆì–´ì„œ ì˜ ì‚¬ìš©ë˜ì§€ëŠ” ì•ŠëŠ”ë‹¤ |
| `default`                 | ê¸°ë³¸ ì„¤ì • ê°’                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `choices`                 | ì„ íƒ                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `max_length`              | ìµœëŒ€ ë¬¸ìì—´ ìˆ˜(CharField ì— í•´ë‹¹)                                                                                                                                                                                                                                                                                                                                                                                                    |
| `auto_now_add` `auto_now` | í˜„ì¬ ì‹œê°„ ì ìš©                                                                                                                                                                                                                                                                                                                                                                                                                    |

## ORM ë¶„ì„.

---

### [ ëª¨ë¸ ì½”ë“œ ]

[**â–¶ï¸ ê¹ƒí—™ ë°”ë¡œê°€ê¸°**](https://github.com/lee-lou2/django-tutorial/blob/main/book/models/book.py)

### ğŸ—’ï¸ ì¿¼ë¦¬ì…‹ ì¡°íšŒ

```python
# all() ì€ ì¿¼ë¦¬ì…‹ì¸ê°€?
self.assertTrue(isinstance(
    Book.objects.all(),
    QuerySet
))

# filter() ëŠ” ì¿¼ë¦¬ì…‹ì¸ê°€?
self.assertTrue(isinstance(
    Book.objects.filter(title="test"),
    QuerySet
))

# filter().first() ëŠ” ì¿¼ë¦¬ì…‹ì´ ì•„ë‹Œê°€?
self.assertFalse(isinstance(
    Book.objects.filter(title="test").first(),
    QuerySet
))
```

### ğŸ—’ï¸ ê°ì²´ ì¡°íšŒ

```python
# get(pk) ì„ ì´ìš©í•œ ì¡°íšŒ
obj1 = Book.objects.get(pk=1)
# get(id) ë¥¼ ì´ìš©í•œ ì¡°íšŒ
obj2 = Book.objects.get(id=1)
# get_object_or_404 ë¥¼ ì´ìš©í•œ ì¡°íšŒ
obj3 = get_object_or_404(Book, pk=1)
# first ë¥¼ ì´ìš©í•œ ì¡°íšŒ
obj4 = Book.objects.filter(id=1).first()
# last ë¥¼ ì´ìš©í•œ ì¡°íšŒ
obj5 = Book.objects.filter(id=1).last()
# ìŠ¬ë¼ì´ì‹±ì„ ì´ìš©í•œ ì¡°íšŒ
obj6 = Book.objects.filter(title=obj1.title)[0]

# ëª¨ë‘ ë™ì¼
self.assertTrue(
    obj1 == obj2 == obj3 == obj4 == obj5 == obj6
)
```

### ğŸ—’ï¸ ëª¨ë¸ ë§¤ë‹ˆì € ì‚¬ìš©

```python
class UserQuerySet(models.QuerySet):
    """ì‚¬ìš©ì ì¿¼ë¦¬ì…‹"""
    def only_author(self):
        return self.exclude(author=None)

class UserManager(models.Manager):
    """ì‚¬ìš©ì ê´€ë¦¬"""
    def get_queryset(self):
        return UserQuerySet(self.model, using=self._db)

    def only_author(self):
        return self.get_queryset().only_author()

    def exclude_author(self):
        return self.filter(author=None)

class User(models.Model):
    """ì‚¬ìš©ì"""
    email = models.EmailField(help_text="ì´ë©”ì¼ ì£¼ì†Œ", primary_key=True)

    def get_posts(self, title: str = "", content: str = ""):
        """ì‘ì„±í•œ ëª¨ë“  í¬ìŠ¤íŠ¸ ì¡°íšŒ"""
        return self.post_set.filter(
            title__icontains=title,
            content__icontains=content
        )

    # ë§¤ë‹ˆì € ì˜¤ë²„ë¼ì´ë”©
    objects = UserManager()

    class Meta:
        db_table = "user"
```

```python
# ê¸°ë³¸ í•¨ìˆ˜
user = User.objects.first()

# ê¸°ë³¸ í•¨ìˆ˜ ì‚¬ìš©
user.get_posts(title="test")

# ë§¤ë‹ˆì € í™œìš©
self.assertEqual(
    User.objects.filter(author=None).count(),
    User.objects.exclude_author().count()
)

# ë§¤ë‹ˆì €ì˜ í•œê³„
with self.assertRaises(AttributeError):
    User.objects.filter(
        email__icontains="test"
    ).exclude_author().count()

# ì»¤ìŠ¤í…€ ì¿¼ë¦¬ì…‹ í™œìš©1
self.assertEqual(
    # ì¼ë°˜ í•„í„°ë§ê³¼ ì¿¼ë¦¬ì…‹ ë¹„êµ
    User.objects.exclude(author=None).count(),
    User.objects.only_author().count()
)
# ì»¤ìŠ¤í…€ ì¿¼ë¦¬ì…‹ í™œìš©2
self.assertEqual(
    # ì¼ë°˜ í•„í„°ë§ê³¼ ì¿¼ë¦¬ì…‹ ë¹„êµ
    User.objects.filter(
        email__icontains="test"
    ).exclude(author=None).count(),
    User.objects.filter(
        email__icontains="test"
    ).only_author().only_author().count()  # <- ì²´ì¸ í˜•íƒœë¡œ í™œìš© ê°€ëŠ¥
)
```

### ğŸ—’ï¸ annotate í™œìš©

```python
# GroupBy ì¼ë°˜
self.assertEqual(
    str(PostLike.objects.values("post").annotate(
        like_count=Count("post")
    ).query),
    (
        'SELECT '
        '"post_like"."post_id", '
        'COUNT("post_like"."post_id") AS "like_count" '
        'FROM "post_like" '
        'GROUP BY "post_like"."post_id"'
    )
)
self.assertEqual(
    PostLike.objects.values("post").annotate(
        like_count=Count("post")
    ).count(),
    PostLike.objects.values("post").distinct().count()
)

# GroupBy ì˜ëª»ëœ ì‚¬ë¡€
self.assertEqual(
    str(PostLike.objects.values("post").annotate(
        like_count=Count("post")
    ).values().query),
    (
        'SELECT '
        '"post_like"."id", '
        '"post_like"."user_id", '
        '"post_like"."post_id", '
        '"post_like"."created", '
        'COUNT("post_like"."post_id") AS "like_count" '
        'FROM "post_like" '
        'GROUP BY '
        '"post_like"."post_id", '
        '"post_like"."id", '
        '"post_like"."user_id", '
        '"post_like"."created"'
    )
)
# ì „ì²´ ì¹´ìš´íŠ¸ì™€ ê°™ì•„ì§
self.assertEqual(
    PostLike.objects.values("post").annotate(
        like_count=Count("post")
    ).values().count(),
    PostLike.objects.count()
)

# ì‹ ê·œ ì»¬ëŸ¼ ì¶”ê°€
objs = PostLike.objects.values("post").annotate(
    additional_field=Value("test")
)
for obj in objs:
    self.assertEqual(obj.get("additional_field"), "test")
self.assertEqual(
    str(objs.query),
    (
        'SELECT '
        '"post_like"."post_id", '
        'test AS "additional_field" '
        'FROM "post_like"'
    )
)

# Having ì¿¼ë¦¬
self.assertEqual(
    str(PostLike.objects.values("post").annotate(
        like_count=Count("post")
    ).filter(like_count__lte=1).query),
    (
        'SELECT '
        '"post_like"."post_id", '
        'COUNT("post_like"."post_id") AS "like_count" '
        'FROM "post_like" '
        'GROUP BY "post_like"."post_id" '
        'HAVING COUNT("post_like"."post_id") <= 1'
    )
)
```

### ğŸ—’ï¸ aggregate í™œìš©

```python
# ì „ì²´ ë°ì´í„° ê´€ë¦¬
self.assertEqual(
    PostLike.objects.aggregate(Count("user")).get("user__count"),
    PostLike.objects.count()
)
self.assertEqual(
    type(PostLike.objects.aggregate(Count("user"))),
    dict
)
```

### ğŸ—’ï¸ ORM ì´ìŠˆ(n+1)

```python
# ë°ì´í„° ì¡°íšŒ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©
resp = []

# ----
# ì •ì°¸ì¡°
# ----
# 1. í•´ë‹¹ ëª¨ë¸ì˜ ì»¬ëŸ¼ì„ ì¡°íšŒ
objs = UserProfile.objects.all()
for obj in objs:
    resp.append(obj.name)

# 2. n+1 ì´ìŠˆ
for obj in objs:
    resp.append(obj.user.email)

# 3. ì´ìŠˆ ê°œì„ (select_related)
for obj in objs.select_related("user"):
    resp.append(obj.user.email)

# ---
# ì—­ì°¸ì¡°
# ---
# 1. í•´ë‹¹ ëª¨ë¸ì˜ ì»¬ëŸ¼ ì¡°íšŒ
objs = User.objects.all()
for obj in objs:
    resp.append(obj.pk)

# 2. n+1 ì´ìŠˆ
for obj in objs:
    resp.append(obj.r_profile.name)

# 3. ì´ìŠˆ ê°œì„ 
for obj in objs.prefetch_related("r_profile"):
    resp.append(obj.r_profile.name)
```

### ğŸ—’ï¸ ì„œë¸Œ ì¿¼ë¦¬ í™œìš©

```python
# ì •ìƒì ì¸ ì‚¬ìš© ë°©ë²•
PostLike.objects.values("user").annotate(
    user_name=Subquery(
        UserProfile.objects.filter(user=OuterRef("user")).values("name"),
        output_field=CharField()
    )
)
# ì„œë¸Œì¿¼ë¦¬ì— ë°˜í™˜ë˜ëŠ” ì»¬ëŸ¼ì˜ ìˆ˜ê°€ 1ê°œ ì´ìƒì¸ ê²½ìš° ì˜¤ë¥˜ ë°œìƒ
with self.assertRaises(OperationalError):
    print(PostLike.objects.values("user").annotate(
        user_name=Subquery(
            UserProfile.objects.filter(user=OuterRef("user")),
            output_field=CharField()
        )
    ))
```

### ğŸ—’ï¸ ë¡œìš° í•¨ìˆ˜ ì‚¬ìš©

```python
# ê¸°ë³¸ ì¡°íšŒ
users = UserProfile.objects.raw("SELECT * FROM user_profile")
for user in users:
    self.assertTrue(isinstance(user, UserProfile))

# ë‹¤ë¥¸ í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ
users = UserProfile.objects.raw("SELECT * FROM author")
for user in users:
    # UserProfile ê°ì²´ë¡œ ì¡°íšŒëœë‹¤
    self.assertTrue(isinstance(user, UserProfile))
    # ë‹¨ìˆœíˆ pk ë§Œ ì¼ì¹˜ ì‹œì¼œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ë‹¤
    # => raw ëŠ” ë°ì´í„° ì „ì²´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ê²Œ ì•„ë‹ˆë¼ pk ë§Œ ê°€ì ¸ì˜¨ë‹¤
    # => ì‹¬ì§€ì–´ ëª¨ë¸ì— í¬í•¨ëœ ë°ì´í„°ë¥¼ ì¡°íšŒ í• ë•Œë„ n+1 ì´ìŠˆê°€ ë°œìƒ(ë§¤ë²ˆ ì¿¼ë¦¬ í˜¸ì¶œ)
    self.assertEqual(user.name, UserProfile.objects.get(pk=user.pk).name)

# Primary Key íƒ€ì…ì´ ë‹¤ë¥¸ ê²½ìš° ì˜¤ë¥˜ ë°œìƒ
with self.assertRaises(FieldDoesNotExist):
    users = UserProfile.objects.raw("SELECT * FROM user")
    for user in users:
        self.assertTrue(isinstance(user, UserProfile))
```

### ğŸ—’ï¸ union(ë™ì¼í•œ í˜•íƒœ í…Œì´ë¸” ê²°í•©)

```python
books = Book.objects.all()
new_books = NewBook.objects.all()
all_book = books.union(new_books)

self.assertEqual(all_book.count(), 6000)
self.assertEqual(
    str(books.union(new_books).query),
    (
        'SELECT '
        '"book"."id", "book"."title" '
        'FROM "book" '
        'UNION SELECT '
        '"new_book"."id", "new_book"."title" '
        'FROM "new_book"'
    )
)
self.assertEqual(all_book.values("title").count(), 6000)
```

### ğŸ—’ï¸ union(ë‹¤ë¥¸ í˜•íƒœì˜ í…Œì´ë¸” ê²°í•©)

```python
Book.objects.bulk_create([
    Book(title=f"test_{i}") for i in range(10)
])
NewBookV2.objects.bulk_create([
    NewBookV2(name=f"test_v2_{i}") for i in range(10)
])
# ê°€ëŠ¥í•œ ëª…ë ¹
all_book = Book.objects.all().union(NewBookV2.objects.all())
for book in all_book:
    # 1. ëª¨ë“  ê°ì²´ê°€ Book ëª¨ë¸ë¡œ ë³€ê²½ëœë‹¤
    self.assertTrue(isinstance(book, Book))
    # 2. name í•„ë“œê°€ ìë™ìœ¼ë¡œ title ë¡œ ë³€ê²½ëë‹¤
    # ì–´ë–»ê²Œ? > ë‹¨ìˆœíˆ ìˆœì„œì— ì˜í•´ì„œ!
    self.assertTrue(hasattr(book, "title"))
with self.assertRaises(FieldError):
    # 3. nameì´ title ë¡œ ë³€ê²½ëì§€ë§Œ values ëª…ë ¹ì–´ëŠ” ë¶ˆê°€ëŠ¥
    self.assertEqual(all_book.values().count(), 20)
# ì¿¼ë¦¬ í™•ì¸
self.assertEqual(
    str(all_book.query),
    (
        'SELECT '
        '"book"."id", "book"."title" '
        'FROM "book" '
        'UNION SELECT '
        '"new_book_v2"."id", "new_book_v2"."name" '
        'FROM "new_book_v2"'
    )
)

# ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ?
all_book = Book.objects.all().union(
    # ë”°ë¡œ ì»¬ëŸ¼ì„ ë³€ê²½í•´ì£¼ëŠ” ì‘ì—…ì´ í•„ìš”
    NewBookV2.objects.all().values(
        "id", "name"
    ).annotate(
        title=F("name")
    ).values("id", "title")
)
# í™œìš© ê°€ëŠ¥
self.assertEqual(all_book.values().count(), 20)
# ì¿¼ë¦¬ í™•ì¸
self.assertEqual(
    str(all_book.query),
    (
        'SELECT '
        '"book"."id", "book"."title" '
        'FROM "book" '
        'UNION SELECT '
        '"new_book_v2"."id", "new_book_v2"."name" AS "title" '
        'FROM "new_book_v2"'
    )
)
```